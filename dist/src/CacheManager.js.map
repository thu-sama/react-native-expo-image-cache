{"version":3,"sources":["../../src/CacheManager.js"],"names":["_","BASE_DIR","FileSystem","cacheDirectory","CacheEntry","uri","options","getCacheEntry","path","exists","tmpPath","createDownloadResumable","downloadAsync","result","status","undefined","moveAsync","from","to","CacheManager","entries","deleteAsync","idempotent","makeDirectoryAsync","getInfoAsync","size","filename","substring","lastIndexOf","indexOf","length","ext","uniqueId","info"],"mappings":"ioBACA,8B,GAAYA,E,kCACZ,0BACA,mC,qfAOA,GAAMC,UAAcC,iBAAWC,cAAzB,oBAAN,C,GAEaC,W,SAAAA,U,YAMT,oBAAYC,GAAZ,CAAyBC,OAAzB,CAAmD,kCAC/C,KAAKD,GAAL,CAAWA,GAAX,CACA,KAAKC,OAAL,CAAeA,OAAf,CACH,C,iOAGUD,G,CAAgB,I,CAAhBA,G,CAAKC,O,CAAW,I,CAAXA,O,iDAC0BC,cAAcF,GAAd,C,4BAA/BG,I,MAAAA,I,CAAMC,M,MAAAA,M,CAAQC,O,MAAAA,O,KACjBD,M,yDACOD,I,0DAEUN,iBAAWS,uBAAX,CAAmCN,GAAnC,CAAwCK,OAAxC,CAAiDJ,OAAjD,EAA0DM,aAA1D,E,UAAfC,M,oBAEFA,QAAUA,OAAOC,MAAP,GAAkB,G,2DACrBC,S,2DAELb,iBAAWc,SAAX,CAAqB,CAAEC,KAAMP,OAAR,CAAiBQ,GAAIV,IAArB,CAArB,C,0CACCA,I,wFAIMW,a,qJAINd,G,CAAaC,O,CAAsC,CAC1D,GAAI,CAACa,aAAaC,OAAb,CAAqBf,GAArB,CAAL,CAAgC,CAC5Bc,aAAaC,OAAb,CAAqBf,GAArB,EAA4B,GAAID,WAAJ,CAAeC,GAAf,CAAoBC,OAApB,CAA5B,CACH,CACD,MAAOa,cAAaC,OAAb,CAAqBf,GAArB,CAAP,CACH,C,uNAGSH,iBAAWmB,WAAX,CAAuBpB,QAAvB,CAAiC,CAAEqB,WAAY,IAAd,CAAjC,C,0DACApB,iBAAWqB,kBAAX,CAA8BtB,QAA9B,C,uSAGeC,iBAAWsB,YAAX,CAAwBvB,QAAxB,CAAkC,CAACwB,KAAM,IAAP,CAAlC,C,8BAAdA,I,OAAAA,I,kCACAA,I,+FAfJL,O,CAAyC,E,wBAF/BD,Y,CAqBrB,GAAMZ,eAAgB,QAAhBA,cAAgB,CAAOF,GAAP,qKACZqB,QADY,CACDrB,IAAIsB,SAAJ,CAActB,IAAIuB,WAAJ,CAAgB,GAAhB,CAAd,CAAoCvB,IAAIwB,OAAJ,CAAY,GAAZ,IAAqB,CAAC,CAAtB,CAA0BxB,IAAIyB,MAA9B,CAAuCzB,IAAIwB,OAAJ,CAAY,GAAZ,CAA3E,CADC,CAEZE,GAFY,CAENL,SAASG,OAAT,CAAiB,GAAjB,IAA0B,CAAC,CAA3B,CAA+B,MAA/B,CAAwCH,SAASC,SAAT,CAAmBD,SAASE,WAAT,CAAqB,GAArB,CAAnB,CAFlC,CAGZpB,IAHY,IAGFP,QAHE,CAGS,kBAAKI,GAAL,CAHT,CAGqB0B,GAHrB,CAIZrB,OAJY,IAICT,QAJD,CAIY,kBAAKI,GAAL,CAJZ,KAIyBL,EAAEgC,QAAF,EAJzB,CAIwCD,GAJxC,mEAOR7B,iBAAWqB,kBAAX,CAA8BtB,QAA9B,CAPQ,sJAWCC,iBAAWsB,YAAX,CAAwBhB,IAAxB,CAXD,UAWZyB,IAXY,gBAYXxB,MAZW,CAYDwB,IAZC,CAYXxB,MAZW,kCAaX,CAAEA,aAAF,CAAUD,SAAV,CAAgBE,eAAhB,CAbW,qEAAtB","file":"CacheManager.js","sourcesContent":["// @flow\nimport * as _ from \"lodash\";\nimport {FileSystem} from \"expo\";\nimport SHA1 from \"crypto-js/sha1\";\n\nexport type DownloadOptions = {\n  md5?: boolean,\n  headers?: { [string]: string }\n};\n\nconst BASE_DIR = `${FileSystem.cacheDirectory}expo-image-cache/`;\n\nexport class CacheEntry {\n\n    uri: string;\n    options: DownloadOptions;\n    path: string;\n\n    constructor(uri: string, options: DownloadOptions) {\n        this.uri = uri;\n        this.options = options;\n    }\n\n    async getPath(): Promise<?string> {\n        const {uri, options} = this;\n        const {path, exists, tmpPath} = await getCacheEntry(uri);\n        if (exists) {\n            return path;\n        }\n        const result = await FileSystem.createDownloadResumable(uri, tmpPath, options).downloadAsync();\n        // If the image download failed, we don't cache anything\n        if (result && result.status !== 200) {\n            return undefined;\n        }\n        await FileSystem.moveAsync({ from: tmpPath, to: path });\n        return path;\n    }\n}\n\nexport default class CacheManager {\n\n    static entries: { [uri: string]: CacheEntry } = {};\n\n    static get(uri: string, options: DownloadOptions): CacheEntry {\n        if (!CacheManager.entries[uri]) {\n            CacheManager.entries[uri] = new CacheEntry(uri, options);\n        }\n        return CacheManager.entries[uri];\n    }\n\n    static async clearCache(): Promise<void> {\n        await FileSystem.deleteAsync(BASE_DIR, { idempotent: true });\n        await FileSystem.makeDirectoryAsync(BASE_DIR);\n    }\n    static async getCacheSize(): Promise<number> {\n        const {size} = await FileSystem.getInfoAsync(BASE_DIR, {size: true});\n        return size;\n    }\n}\n\nconst getCacheEntry = async (uri: string): Promise<{ exists: boolean, path: string, tmpPath: string }> => {\n    const filename = uri.substring(uri.lastIndexOf(\"/\"), uri.indexOf(\"?\") === -1 ? uri.length : uri.indexOf(\"?\"));\n    const ext = filename.indexOf(\".\") === -1 ? \".jpg\" : filename.substring(filename.lastIndexOf(\".\"));\n    const path = `${BASE_DIR}${SHA1(uri)}${ext}`;\n    const tmpPath = `${BASE_DIR}${SHA1(uri)}-${_.uniqueId()}${ext}`;\n    // TODO: maybe we don't have to do this every time\n    try {\n        await FileSystem.makeDirectoryAsync(BASE_DIR);\n    } catch (e) {\n        // do nothing\n    }\n    const info = await FileSystem.getInfoAsync(path);\n    const {exists} = info;\n    return { exists, path, tmpPath };\n};\n"]}